# Salesforce Application Data Fix Script

This script helps fix Application Step Results (ASRs) in Salesforce, particularly when a fix might lead to re-grading and state changes for affected applications. For example, it can be used if an ASR score was calculated incorrectly and needs correction and propagation.

## How to use

The script generally operates in stages. You will need to modify the `src/index.ts` file to control which stage is executed.

### I. Prerequisites & Setup

1.  **Clone Repository**: Ensure you have the `xo-hiring-monorepo` cloned and navigate to the `packages/xoh-data-fix-utils` directory.
2.  **Install Dependencies**:
    ```bash
    npm install
    ```
3.  **Environment Variables**:
    - Copy the `.env.template` file to a new file named `.env` in the `packages/xoh-data-fix-utils` directory.
    - Add additional variables in the `.env` file (depending on your logic)

### II. Configuration in `src/index.ts`

Before each run, you must configure `packages/xoh-data-fix-utils/src/index.ts`:

1.  **Update `AffectedAsrs` List**:

    - Locate the `AffectedAsrs` array.
    - Populate this array with the Salesforce `Application_Step_Result__c` record IDs that you intend to process.

    ```typescript
    const AffectedAsrs = [
      'a0BIj000002d9xlMAA', // Example ID 1
      'a0BIj000002d93yMAA', // Example ID 2
      // ... add other ASR IDs here
    ];
    ```

2.  **Create and Define Your Main Operational Function**:
    The script's logic is best orchestrated within a dedicated async function. You should **create your own function** (e.g., `runMyDataFixProcess`) to manage the stages. This function will call the stage-specific helper functions like `sfCalculateApplicationFixes` and `sfActOnActions`.

    You'll need to uncomment the lines corresponding to the stage you want to execute within your custom function and comment out others.

    - **Stage 1: Calculate Application Fixes**

      - **Prerequisite**: This stage assumes that the `Score__c` on the ASRs listed in `AffectedAsrs` has already been corrected and updated in Salesforce. Any necessary re-grading or manual data fixes for the ASR scores themselves must be completed _before_ running this stage.
      - Uncomment the call to `sfCalculateApplicationFixes()`, passing it the `AffectedAsrs` (or a specific subset) within your main operational function:

      ```typescript
      // Inside your async function, e.g., runMyDataFixProcess()
      await sfCalculateApplicationFixes(AffectedAsrs); // Or, e.g., ['a0BIj000002chPxMAI']
      ```

      - This function analyzes the impact of the (now corrected) ASR scores on all related candidate applications.
      - **Output**: It generates a file named `actions.json` in the `packages/xoh-data-fix-utils` directory. This file details proposed actions (e.g., `Restore` to a previous stage, `Reject`, `NotifyHM`) for each affected application based on their current ASR scores.
      - **CRUCIAL STEP**: **Thoroughly review `actions.json`**. Verify that the proposed changes are accurate and intended before proceeding to the next stage.

    - **Stage 2: Apply Calculated Fixes**
      - Only proceed to this stage after you have carefully reviewed and approved the contents of `actions.json`.
      - Ensure the call to `sfCalculateApplicationFixes()` is commented out in your main operational function.
      - Uncomment the call to `sfActOnActions()`:
      ```typescript
      // Inside your async function, e.g., runMyDataFixProcess()
      await sfActOnActions(); // This function reads ./actions.json
      ```

### III. Running the Script

1.  After configuring `src/index.ts` for the desired stage, open your terminal.
2.  Ensure you are in the `packages/xoh-data-fix-utils` directory.
3.  Execute the script:
    ```bash
    npm run doFix
    ```
4.  Monitor the console output for progress, logs, and any potential error messages.

### IV. Recommended Workflow Summary

1.  **Setup**:
    - Install dependencies (`npm install`).
    - Configure `.env` with credentials.
2.  **Stage 1 (Calculate Fixes)**:
    - **Important Prerequisite**: Ensure ASR scores are already corrected in Salesforce.
    - In `src/index.ts`, update `AffectedAsrs`.
    - In your main operational function (e.g., `runMyDataFixProcess`), uncomment `await sfCalculateApplicationFixes(AffectedAsrs);`. Comment out `sfActOnActions()`.
    - Run `npm run doFix`.
    - **MANDATORY: Review the generated `actions.json` file carefully.**
3.  **Stage 2 (Apply Fixes)**:
    - In your main operational function, comment out `sfCalculateApplicationFixes()`. Uncomment `await sfActOnActions();`.
    - Run `npm run doFix`.
    - Review the generated `csvReport.json` and `csvReport.csv` for a log of actions taken.

### V. Understanding Output Files

- **`actions.json`**:

  - **Generated by**: Stage 1 (`sfCalculateApplicationFixes`).
  - **Purpose**: Contains a list of proposed changes (Restore, Reject, NotifyHM, etc.) for applications affected by the ASR updates.
  - **Action**: Must be reviewed carefully before proceeding to Stage 2.
  - **Format**: JSON array of `ActionData` objects (defined in `src/logic/model.ts`).

- **`csvReport.json` & `csvReport.csv`**:
  - **Generated by**: Stage 2 (`sfActOnActions`).
  - **Purpose**: Provide a log of the actions actually performed in Salesforce. Useful for auditing, confirmation, and record-keeping. Attach it to the ticket for the customer success managers to notify the candidates about the updates.
  - **Format**: `csvReport.json` is a JSON array; `csvReport.csv` is a standard CSV file.

### VI. Example `src/index.ts` Configuration (for Stage 2)

Below is an example of how `src/index.ts` might look when configured for Stage 1 (Calculate Application Fixes), using a custom main operational function named `runMyDataFixProcess`:

```typescript
import 'dotenv/config';
// ... other imports from your index.ts file

// Salesforce.silent(); // Ensure this or similar setup is present
// const log = defaultLogger(); // Ensure logger is setup

const AffectedAsrs = [
  'a0BIj000002d9xlMAA',
  // ... other ASR IDs
];

// Assuming sfCalculateApplicationFixes, sfActOnActions are imported or defined in this file

async function runMyDataFixProcess() {
  // Your custom main operational function
  // STAGE 1: Calculate application fixes
  // Prerequisite: Ensure ASR scores (in AffectedAsrs) are already corrected in Salesforce.
  log.info('Starting Stage 1: Calculate Application Fixes...');
  await sfCalculateApplicationFixes(AffectedAsrs);
  log.info('Stage 1 completed. Please review actions.json before proceeding to Stage 2.');

  // STAGE 2: Apply calculated fixes (ensure this is commented out for Stage 1)
  // log.info('Starting Stage 2: Apply Calculated Fixes...');
  // await sfActOnActions();
  // log.info('Stage 2 completed. Check csvReport.json and csvReport.csv.');
}

(async () => {
  try {
    await runMyDataFixProcess(); // Call your main operational function here
    log.info('Script execution finished.');
  } catch (error) {
    log.error('An error occurred during script execution:', error);
    process.exit(1);
  }
})();
```

**Important Considerations**:

- This script performs direct data modifications in your Salesforce organization. Always run and test in a Sandbox environment first.
- Ensure the user/credentials in `.env` have the necessary permissions in Salesforce to read ASRs, Applications, Histories, and update Application records.
- Backup any critical data before running widespread changes.
